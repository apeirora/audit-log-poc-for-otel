version: "3"

description:

includes:
  tools:
    desc: Install required tools (k3d, kubectl, kind).
    taskfile: ./tools.yaml

tasks:
  install:
    desc:
    requires:
      vars: [KUBECTL_CMD]
    status:
      - "{{ .KUBECTL_CMD }} get ns | grep tier- >/dev/null 2>&1"
      - "{{ .KUBECTL_CMD }} get ClusterRole | grep otelcol-agent >/dev/null 2>&1"
      - "{{ .KUBECTL_CMD }} get ClusterRoleBinding | grep otelcol-agent >/dev/null 2>&1"
    cmds:
      - "{{ .KUBECTL_CMD }} apply -f kubectl/cluster.yaml"

  uninstall:
    desc:
    requires:
      vars: [KUBECTL_CMD]
    status:
      - "! {{ .KUBECTL_CMD }} get ns | grep tier- >/dev/null 2>&1"
      - "! {{ .KUBECTL_CMD }} get ClusterRole | grep otelcol-agent >/dev/null 2>&1"
      - "! {{ .KUBECTL_CMD }} get ClusterRoleBinding | grep otelcol-agent >/dev/null 2>&1"
    cmds:
      - "{{ .KUBECTL_CMD }} delete -f kubectl/cluster.yaml --ignore-not-found"
